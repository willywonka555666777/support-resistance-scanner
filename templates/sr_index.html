<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support & Resistance Scanner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <nav class="navbar navbar-dark bg-dark mb-4">
            <div class="container-fluid">
                <span class="navbar-brand mb-0 h1">üìä Support & Resistance Scanner</span>
                <div class="d-flex">
                    <button class="btn btn-success me-2" onclick="scanOpportunities()">üîç Scan All</button>
                    <span id="last-update" class="text-light small"></span>
                </div>
            </div>
        </nav>

        <div class="row">
            <!-- Controls -->
            <div class="col-md-3">
                <div class="card mb-3">
                    <div class="card-header">‚öôÔ∏è Scan Settings</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Max Support Distance (%)</label>
                            <input type="number" class="form-control" id="support-dist" value="10" step="0.5">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Max Resistance Distance (%)</label>
                            <input type="number" class="form-control" id="resistance-dist" value="8" step="0.5">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Timeframes</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="15m" id="tf-15m" checked>
                                <label class="form-check-label" for="tf-15m">15 minutes</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="1h" id="tf-1h" checked>
                                <label class="form-check-label" for="tf-1h">1 hour</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="4h" id="tf-4h" checked>
                                <label class="form-check-label" for="tf-4h">4 hours</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="1d" id="tf-1d" checked>
                                <label class="form-check-label" for="tf-1d">1 day</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="1M" id="tf-1M">
                                <label class="form-check-label" for="tf-1M">1 month</label>
                            </div>
                        </div>
                        <button class="btn btn-primary w-100 mb-2" id="scan-btn" onclick="scanOpportunities()">Start Scan</button>
                        <button class="btn btn-danger w-100" id="stop-btn" onclick="stopScan()" style="display: none;">Stop Scan</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">üéØ Quick Analysis</div>
                    <div class="card-body">
                        <select class="form-select mb-2" id="coin-select">
                            <option value="">Select coin...</option>
                        </select>
                        <button class="btn btn-info w-100" onclick="analyzeSingleCoin()">Analyze</button>
                    </div>
                </div>
            </div>

            <!-- Results -->
            <div class="col-md-9">
                <!-- Opportunities -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between">
                        <span>üö® Trading Opportunities</span>
                        <span id="opportunities-count" class="badge bg-secondary">0</span>
                    </div>
                    <div class="card-body">
                        <div id="loading" class="text-center" style="display: none;">
                            <div class="spinner-border" role="status"></div>
                            <p>Scanning coins...</p>
                        </div>
                        <div id="opportunities-list"></div>
                    </div>
                </div>

                <!-- Single Coin Analysis -->
                <div class="card" id="single-analysis" style="display: none;">
                    <div class="card-header">üìà Detailed Analysis</div>
                    <div class="card-body">
                        <div id="coin-details"></div>
                        <div id="timeframe-analysis"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Load coins on page load
        window.onload = function() {
            loadCoins();
        };

        function loadCoins() {
            const timestamp = new Date().getTime();
            fetch(`/get-coins?t=${timestamp}`, {
                method: 'GET',
                headers: {
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(coins => {
                if (coins.error) {
                    console.error('Error loading coins:', coins.error);
                    return;
                }
                const select = document.getElementById('coin-select');
                select.innerHTML = '<option value="">Select coin...</option>';
                coins.forEach(coin => {
                    select.innerHTML += `<option value="${coin.id}">${coin.name} (${coin.symbol})</option>`;
                });
            })
            .catch(error => {
                console.error('Failed to load coins:', error);
            });
        }

        function getSelectedTimeframes() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value).join(',');
        }

        function scanOpportunities() {
            const supportDist = document.getElementById('support-dist').value;
            const resistanceDist = document.getElementById('resistance-dist').value;
            const timeframes = getSelectedTimeframes();
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('opportunities-list').innerHTML = '';
            document.getElementById('scan-btn').style.display = 'none';
            document.getElementById('stop-btn').style.display = 'block';
            
            fetch(`/scan-opportunities?support_dist=${supportDist}&resistance_dist=${resistanceDist}&timeframes=${timeframes}`)
            .then(response => response.json())
            .then(opportunities => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('scan-btn').style.display = 'block';
                document.getElementById('stop-btn').style.display = 'none';
                displayOpportunities(opportunities);
                document.getElementById('last-update').textContent = 'Updated: ' + new Date().toLocaleTimeString();
            });
        }

        function stopScan() {
            fetch('/stop-scan', {method: 'POST'})
            .then(() => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('scan-btn').style.display = 'block';
                document.getElementById('stop-btn').style.display = 'none';
            });
        }

        function displayOpportunities(opportunities) {
            const container = document.getElementById('opportunities-list');
            document.getElementById('opportunities-count').textContent = opportunities.length;
            
            if (opportunities.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No opportunities found</p>';
                return;
            }

            container.innerHTML = '';
            opportunities.forEach(opp => {
                const coin = opp.coin;
                const opps = opp.opportunities;
                
                const card = document.createElement('div');
                card.className = 'card mb-3';
                
                let oppsHtml = '';
                opps.forEach(o => {
                    const badgeClass = o.signal === 'BUY' ? 'bg-success' : 'bg-danger';
                    const typeIcon = o.type === 'SUPPORT' ? 'üìà' : 'üìâ';
                    
                    oppsHtml += `
                        <div class="col-md-6 mb-2">
                            <div class="alert alert-${o.signal === 'BUY' ? 'success' : 'danger'} py-2">
                                <strong>${typeIcon} ${o.type}</strong><br>
                                <small>
                                    ${o.timeframe} | $${o.level} | ${o.distance_pct}% away<br>
                                    <span class="badge ${badgeClass}">${o.signal}</span>
                                </small>
                            </div>
                        </div>
                    `;
                });

                card.innerHTML = `
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <h6>${coin.name}</h6>
                                <small class="text-muted">${coin.symbol.toUpperCase()}</small><br>
                                <strong>$${coin.current_price.toFixed(4)}</strong>
                            </div>
                            <div class="col-md-9">
                                <div class="row">
                                    ${oppsHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        function analyzeSingleCoin() {
            const coinId = document.getElementById('coin-select').value;
            if (!coinId) return;
            
            // Clear previous analysis
            document.getElementById('single-analysis').style.display = 'none';
            
            const timeframes = getSelectedTimeframes();
            // Add timestamp to prevent caching
            const timestamp = new Date().getTime();
            fetch(`/analyze-coin/${coinId}?timeframes=${timeframes}&t=${timestamp}`, {
                method: 'GET',
                headers: {
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(analysis => {
                if (analysis.error) {
                    alert(`Error: ${analysis.error}`);
                    return;
                }
                displaySingleAnalysis(analysis);
            })
            .catch(error => {
                console.error('Analysis error:', error);
                alert(`Analysis failed: ${error.message}`);
            });
        }

        function displaySingleAnalysis(analysis) {
            const container = document.getElementById('single-analysis');
            const detailsDiv = document.getElementById('coin-details');
            const timeframeDiv = document.getElementById('timeframe-analysis');

            // Coin details with recommendations
            let recommendationsHtml = '';
            if (analysis.recommendations && analysis.recommendations.length > 0) {
                recommendationsHtml = '<div class="alert alert-info"><h6>üìã Trading Recommendations:</h6>';
                analysis.recommendations.forEach(rec => {
                    const badgeClass = rec.type === 'BUY' ? 'bg-success' : 'bg-danger';
                    const confidenceClass = rec.confidence === 'HIGH' ? 'bg-success' : 'bg-warning';
                    
                    recommendationsHtml += `
                        <div class="mb-2 p-2 border rounded">
                            <span class="badge ${badgeClass}">${rec.type}</span>
                            <span class="badge ${confidenceClass}">${rec.confidence}</span>
                            <strong>${rec.timeframe}</strong><br>
                            <small>
                                ${rec.reason}<br>
                                Entry: $${rec.entry_price} | SL: $${rec.stop_loss} | TP: $${rec.take_profit}<br>
                                Risk/Reward: ${rec.risk_reward}:1
                            </small>
                        </div>
                    `;
                });
                recommendationsHtml += '</div>';
            }

            detailsDiv.innerHTML = `
                <div class="row mb-3">
                    <div class="col-md-4">
                        <h5>${analysis.name} (${analysis.symbol.toUpperCase()})</h5>
                        <h4 class="text-primary">$${analysis.current_price.toFixed(4)}</h4>
                        <small class="text-muted">Updated: ${analysis.last_updated || 'Just now'}</small>
                    </div>
                    <div class="col-md-8">
                        ${recommendationsHtml}
                    </div>
                </div>
            `;

            // Timeframe analysis
            let timeframeHtml = '<div class="row">';
            Object.entries(analysis.timeframes).forEach(([tf, data]) => {
                const supportInfo = data.nearest_support ? 
                    `$${data.nearest_support} (${data.support_distance_pct}% away)` : 'None';
                const resistanceInfo = data.nearest_resistance ? 
                    `$${data.nearest_resistance} (${data.resistance_distance_pct}% away)` : 'None';

                timeframeHtml += `
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-header">${tf}</div>
                            <div class="card-body">
                                <p><strong>Support:</strong> ${supportInfo}</p>
                                <p><strong>Resistance:</strong> ${resistanceInfo}</p>
                                <small class="text-muted">
                                    All Supports: ${data.supports.join(', ')}<br>
                                    All Resistances: ${data.resistances.join(', ')}
                                </small>
                            </div>
                        </div>
                    </div>
                `;
            });
            timeframeHtml += '</div>';

            timeframeDiv.innerHTML = timeframeHtml;
            container.style.display = 'block';
        }
    </script>
</body>
</html>