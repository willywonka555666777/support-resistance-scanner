<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Trading Bot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container-fluid">
        <nav class="navbar navbar-dark bg-dark mb-4">
            <div class="container-fluid">
                <span class="navbar-brand mb-0 h1">üöÄ Web Trading Bot</span>
                <div class="d-flex">
                    <span id="scanner-status" class="badge bg-secondary me-2">Scanner: OFF</span>
                    <span id="auto-trading-status" class="badge bg-secondary">Auto Trading: OFF</span>
                </div>
            </div>
        </nav>

        <div class="row">
            <!-- Configuration Panel -->
            <div class="col-md-3">
                <div class="card mb-3">
                    <div class="card-header">‚öôÔ∏è Configuration</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Binance API Key</label>
                            <input type="text" class="form-control" id="api-key" placeholder="API Key">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Secret Key</label>
                            <input type="password" class="form-control" id="secret-key" placeholder="Secret">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Telegram Bot Token</label>
                            <input type="text" class="form-control" id="telegram-token" placeholder="Bot Token">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Telegram Chat ID</label>
                            <input type="text" class="form-control" id="chat-id" placeholder="Chat ID">
                        </div>
                        <button class="btn btn-primary w-100" onclick="updateConfig()">Save Config</button>
                    </div>
                </div>

                <!-- Scanner Controls -->
                <div class="card mb-3">
                    <div class="card-header">üì° Live Scanner</div>
                    <div class="card-body">
                        <button class="btn btn-success w-100 mb-2" onclick="startScanner()">Start Scanner</button>
                        <button class="btn btn-danger w-100" onclick="stopScanner()">Stop Scanner</button>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9">
                <!-- Backtest Panel -->
                <div class="card mb-4">
                    <div class="card-header">üìä Backtest</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Symbol</label>
                                <input type="text" class="form-control" id="bt-symbol" value="BTCUSDT">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="bt-start">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">End Date</label>
                                <input type="date" class="form-control" id="bt-end">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Balance ($)</label>
                                <input type="number" class="form-control" id="bt-balance" value="1000">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Leverage</label>
                                <input type="number" class="form-control" id="bt-leverage" value="10">
                            </div>
                            <div class="col-md-1">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-primary w-100" onclick="runBacktest()">Run</button>
                            </div>
                        </div>
                        
                        <div id="backtest-results" class="mt-4" style="display: none;">
                            <div class="row mb-3">
                                <div class="col-md-2">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h6 id="final-balance">$0</h6>
                                            <small>Final Balance</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h6 id="total-profit">$0</h6>
                                            <small>Total Profit</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h6 id="win-rate">0%</h6>
                                            <small>Win Rate</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h6 id="total-trades">0</h6>
                                            <small>Total Trades</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h6 id="max-profit">$0</h6>
                                            <small>Max Profit</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h6 id="max-loss">$0</h6>
                                            <small>Max Loss</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mb-3">
                                <div class="card-header">üìà Open Positions</div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Side</th>
                                                    <th>Entry Price</th>
                                                    <th>Size</th>
                                                    <th>TP Price</th>
                                                    <th>SL Price</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody id="open-positions-table">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mb-3">
                                <div class="card-header">üíº Closed Trades</div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Entry</th>
                                                    <th>Exit</th>
                                                    <th>Side</th>
                                                    <th>Entry Price</th>
                                                    <th>Exit Price</th>
                                                    <th>P&L</th>
                                                    <th>Duration</th>
                                                    <th>Reason</th>
                                                </tr>
                                            </thead>
                                            <tbody id="closed-trades-table">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <canvas id="equity-chart" class="mt-3"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Optimizer Panel -->
                <div class="card mb-4">
                    <div class="card-header">üéØ Parameter Optimizer</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label">Symbol to Optimize</label>
                                <input type="text" class="form-control" id="opt-symbol" value="BTCUSDT">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-warning w-100 mt-4" onclick="optimizeParameters()">Optimize</button>
                            </div>
                        </div>
                        
                        <div id="optimization-results" class="mt-4" style="display: none;">
                            <div class="row">
                                <div class="col-md-3">
                                    <label class="form-label">Take Profit %</label>
                                    <input type="number" class="form-control" id="opt-tp" readonly>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Stop Loss %</label>
                                    <input type="number" class="form-control" id="opt-sl" readonly>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">RSI Period</label>
                                    <input type="number" class="form-control" id="opt-rsi" readonly>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">MA Period</label>
                                    <input type="number" class="form-control" id="opt-ma" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Signals Log -->
                <div class="card">
                    <div class="card-header">üìà Recent Signals</div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Symbol</th>
                                        <th>Side</th>
                                        <th>Price</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="signals-table">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">No signals yet</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Set default dates
        document.getElementById('bt-start').value = new Date(Date.now() - 30*24*60*60*1000).toISOString().split('T')[0];
        document.getElementById('bt-end').value = new Date().toISOString().split('T')[0];

        function updateConfig() {
            const config = {
                api_key: document.getElementById('api-key').value,
                secret: document.getElementById('secret-key').value,
                telegram_token: document.getElementById('telegram-token').value,
                telegram_chat_id: document.getElementById('chat-id').value
            };

            fetch('/config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => alert('Configuration saved!'));
        }

        function runBacktest() {
            const data = {
                symbol: document.getElementById('bt-symbol').value,
                start_date: document.getElementById('bt-start').value,
                end_date: document.getElementById('bt-end').value,
                balance: document.getElementById('bt-balance').value,
                leverage: document.getElementById('bt-leverage').value
            };

            fetch('/backtest', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                document.getElementById('final-balance').textContent = '$' + result.final_balance.toFixed(2);
                document.getElementById('total-profit').textContent = '$' + result.total_profit.toFixed(2);
                document.getElementById('win-rate').textContent = result.win_rate.toFixed(1) + '%';
                document.getElementById('total-trades').textContent = result.total_trades;
                document.getElementById('max-profit').textContent = '$' + result.max_profit.toFixed(2);
                document.getElementById('max-loss').textContent = '$' + result.max_loss.toFixed(2);
                
                const openTable = document.getElementById('open-positions-table');
                openTable.innerHTML = '';
                result.open_positions.forEach(pos => {
                    const sideClass = pos.side === 'long' ? 'text-success' : 'text-danger';
                    openTable.innerHTML += `
                        <tr>
                            <td>${pos.date}</td>
                            <td><span class="${sideClass}">${pos.side.toUpperCase()}</span></td>
                            <td>$${pos.entry_price.toFixed(2)}</td>
                            <td>${pos.size.toFixed(4)}</td>
                            <td>$${pos.tp_price.toFixed(2)}</td>
                            <td>$${pos.sl_price.toFixed(2)}</td>
                            <td><span class="badge bg-warning">${pos.status}</span></td>
                        </tr>
                    `;
                });
                
                const closedTable = document.getElementById('closed-trades-table');
                closedTable.innerHTML = '';
                result.trades.forEach(trade => {
                    const sideClass = trade.side === 'long' ? 'text-success' : 'text-danger';
                    const profitClass = trade.profit > 0 ? 'text-success' : 'text-danger';
                    const reasonClass = trade.exit_reason === 'TP Hit' ? 'bg-success' : 
                                       trade.exit_reason === 'SL Hit' ? 'bg-danger' : 'bg-secondary';
                    
                    closedTable.innerHTML += `
                        <tr>
                            <td>${trade.entry_date}</td>
                            <td>${trade.exit_date}</td>
                            <td><span class="${sideClass}">${trade.side.toUpperCase()}</span></td>
                            <td>$${trade.entry_price.toFixed(2)}</td>
                            <td>$${trade.exit_price.toFixed(2)}</td>
                            <td><span class="${profitClass}">$${trade.profit.toFixed(2)}</span></td>
                            <td>${trade.duration_hours}h</td>
                            <td><span class="badge ${reasonClass}">${trade.exit_reason}</span></td>
                        </tr>
                    `;
                });
                
                document.getElementById('backtest-results').style.display = 'block';
                
                const ctx = document.getElementById('equity-chart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: result.trades.map(t => t.exit_date),
                        datasets: [{
                            label: 'Balance',
                            data: result.trades.map(t => t.balance),
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: false
                            }
                        }
                    }
                });
            });
        }

        function startScanner() {
            fetch('/scanner/start', {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                document.getElementById('scanner-status').textContent = 'Scanner: ON';
                document.getElementById('scanner-status').className = 'badge bg-success me-2';
            });
        }

        function stopScanner() {
            fetch('/scanner/stop', {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                document.getElementById('scanner-status').textContent = 'Scanner: OFF';
                document.getElementById('scanner-status').className = 'badge bg-secondary me-2';
            });
        }

        function optimizeParameters() {
            const data = {
                symbol: document.getElementById('opt-symbol').value
            };

            fetch('/optimize', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                document.getElementById('opt-tp').value = result.tp_percentage.toFixed(2);
                document.getElementById('opt-sl').value = result.sl_percentage.toFixed(2);
                document.getElementById('opt-rsi').value = result.rsi_period;
                document.getElementById('opt-ma').value = result.ma_period;
                
                document.getElementById('optimization-results').style.display = 'block';
            });
        }
    </script>
</body>
</html>